#!/usr/bin/env python3
"""
Hold-to-talk dictation daemon.
Hold Pause key to record, release to transcribe and type.
"""

import subprocess
import tempfile
import os
import signal
from pynput import keyboard

WHISPER_CLI = os.path.expanduser("~/code/rocm/whisper.cpp.git/build/bin/whisper-cli")
MODEL = os.path.expanduser("~/code/rocm/whisper.cpp.git/models/ggml-large-v3.bin")
AUDIO_SOURCE = subprocess.run(["pactl", "get-default-source"], capture_output=True, text=True).stdout.strip()

recording_process = None
audio_file = None

def notify(message):
    subprocess.run(["notify-send", "-t", "2000", "Dictate", message])

def start_recording():
    global recording_process, audio_file
    audio_file = tempfile.NamedTemporaryFile(suffix=".wav", delete=False)
    audio_file.close()

    recording_process = subprocess.Popen(
        ["ffmpeg", "-y", "-f", "pulse", "-i", AUDIO_SOURCE, "-ar", "16000", "-ac", "1", audio_file.name],
        stdin=subprocess.DEVNULL,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL
    )
    notify("Recording...")

def stop_recording_and_transcribe():
    global recording_process, audio_file

    if recording_process is None:
        return

    # Stop recording
    recording_process.send_signal(signal.SIGINT)
    recording_process.wait()
    recording_process = None

    # Check file has content
    if os.path.getsize(audio_file.name) < 1000:
        notify("No audio captured")
        os.unlink(audio_file.name)
        return

    notify("Transcribing...")

    # Transcribe
    result = subprocess.run(
        [WHISPER_CLI, "-m", MODEL, "-f", audio_file.name, "-np", "-nt"],
        capture_output=True,
        text=True
    )

    text = result.stdout.strip().replace("\n", " ").strip()
    os.unlink(audio_file.name)

    if not text:
        notify("No speech detected")
        return

    notify(f"Done: {text[:50]}...")

    # Type the result
    if os.environ.get("WAYLAND_DISPLAY"):
        subprocess.run(["wtype", text])
    else:
        subprocess.run(["xdotool", "type", "--clearmodifiers", "--", text])

def on_press(key):
    global recording_process
    if key == keyboard.Key.pause and recording_process is None:
        start_recording()

def on_release(key):
    if key == keyboard.Key.pause:
        stop_recording_and_transcribe()

if __name__ == "__main__":
    # Kill any existing instance
    subprocess.run(["pkill", "-f", "python3.*dictate-daemon"], stderr=subprocess.DEVNULL)

    with keyboard.Listener(on_press=on_press, on_release=on_release) as listener:
        listener.join()
